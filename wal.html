<!DOCTYPE html><html lang="en"><head><title>wal</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="wal"><meta name="groc-project-path" content="wal.go"><meta name="groc-github-url" content="https://github.com/eliquious/wallaby"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/eliquious/wallaby/blob/master/wal.go">wal.go</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="wallaby-write-ahead-log">wallaby - Write Ahead Log</h1>
<p>This file contains all of the errors, constants and entry points for wallaby.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">package</span> wallaby

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"bytes"</span>
    <span class="hljs-string">"errors"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"sync"</span>

    <span class="hljs-string">"github.com/eliquious/xbinary"</span>
)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-possible-log-errors-"><strong>Possible Log Errors</strong></h2></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> (</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrReadIndexHeader</code> occurs when the index header cannot be read</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrReadIndexHeader = errors.New(<span class="hljs-string">"failed to read index header"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrWriteIndexHeader</code> occurs when the index header cannot be written</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrWriteIndexHeader = errors.New(<span class="hljs-string">"failed to write index header"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrReadLogHeader</code> occurs when the log header cannot be read</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrReadLogHeader = errors.New(<span class="hljs-string">"failed to read log header"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrWriteLogHeader</code> occurs when the log header cannot be written</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrWriteLogHeader = errors.New(<span class="hljs-string">"failed to write log header"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrSliceOutOfBounds</code> occurs when index.Slice is called and the offset
is larger than the size of the index.</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrSliceOutOfBounds = errors.New(<span class="hljs-string">"read offset out of bounds"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrReadIndex</code> occurs when index.Slice fails to read the records</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrReadIndex = errors.New(<span class="hljs-string">"failed to read index records"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrConfigRequired</code> occurs when no log config is given when creating
or opening a log file.</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrConfigRequired = errors.New(<span class="hljs-string">"log config required"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrInvalidFileVersion</code> occurs when the version in the file header
is unrecognized.</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrInvalidFileVersion = errors.New(<span class="hljs-string">"invalid file version"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrInvalidFileSignature</code> occurs when the signature in the file header
is unrecognized.</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrInvalidFileSignature = errors.New(<span class="hljs-string">"invalid file signature"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrWriteLogRecord</code> occurs when a record fails to be written to the log</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrWriteLogRecord = errors.New(<span class="hljs-string">"failed to write record"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrLogAlreadyOpen</code> occurs when an open log tries to be opened again</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrLogAlreadyOpen = errors.New(<span class="hljs-string">"log already open"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>ErrLogClosed</code> occurs when <code>Append</code> is called after the log has been
closed.</li>
</ul></div></div><div class="code"><div class="wrapper">    ErrLogClosed = errors.New(<span class="hljs-string">"log has been closed"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>ErrRecordTooLarge</code> occurs when writing a record which exceed the max
record size for the log.</p></div></div><div class="code"><div class="wrapper">    ErrRecordTooLarge = errors.New(<span class="hljs-string">"record is too large"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ErrInvalidRecordSize</p></div></div><div class="code"><div class="wrapper">    ErrInvalidRecordSize = errors.New(<span class="hljs-string">"invalid record size"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ErrInvalidSnapshot occurs when a Snapshot cannot be decoded.</p></div></div><div class="code"><div class="wrapper">    ErrInvalidSnapshot = errors.New(<span class="hljs-string">"invalid snapshot"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-log-variables-"><strong>Log Variables</strong></h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Log signature bytes - <code>LOG</code></p></div></div><div class="code"><div class="wrapper">    LogFileSignature = []<span class="hljs-typename">byte</span>(<span class="hljs-string">"LOG"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Index signature bytes - <code>IDX</code></p></div></div><div class="code"><div class="wrapper">    IndexFileSignature = []<span class="hljs-typename">byte</span>(<span class="hljs-string">"IDX"</span>)
)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-log-constants-"><strong>Log Constants</strong></h2></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> (</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>DefaultIndexFlags</code> is the default boolean flags for an index file.</li>
</ul></div></div><div class="code"><div class="wrapper">    DefaultIndexFlags = <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>DefaultRecordFlags</code> represents the default boolean flags for each log record.</li>
</ul></div></div><div class="code"><div class="wrapper">    DefaultRecordFlags <span class="hljs-typename">uint32</span> = <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>DefaultMaxRecordSize</code> is the default maximum size of a log record.</li>
</ul></div></div><div class="code"><div class="wrapper">    DefaultMaxRecordSize = <span class="hljs-number">0xffff</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>LogHeaderSize</code> is the size of the file header.</li>
</ul></div></div><div class="code"><div class="wrapper">    LogHeaderSize = <span class="hljs-number">8</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>VersionOne</code> is an integer denoting the first version</li>
</ul></div></div><div class="code"><div class="wrapper">    VersionOne = <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>VersionOneIndexHeaderSize</code> is the size of the index file header.</li>
</ul></div></div><div class="code"><div class="wrapper">    VersionOneIndexHeaderSize = <span class="hljs-number">8</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>VersionOneIndexRecordSize</code> is the size of the index records.</li>
</ul></div></div><div class="code"><div class="wrapper">    VersionOneIndexRecordSize = <span class="hljs-number">32</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>VersionOneLogHeaderSize</code> is the header size of version 1 log files</li>
</ul></div></div><div class="code"><div class="wrapper">    VersionOneLogHeaderSize = <span class="hljs-number">8</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>VersionOneLogRecordHeaderSize</code> is the size of the log record headers.</li>
</ul></div></div><div class="code"><div class="wrapper">    VersionOneLogRecordHeaderSize = <span class="hljs-number">24</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>MaximumIndexSlice</code> is the maximum number of index records to be read at
one time</li>
</ul></div></div><div class="code"><div class="wrapper">    MaximumIndexSlice = <span class="hljs-number">32000</span>
)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-metadata-"><strong>Metadata</strong></h2>
<p>Metadata simply contains descriptive information about the log</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">type</span> Metadata <span class="hljs-keyword">struct</span> {
    Size             <span class="hljs-typename">int64</span>
    LastModifiedTime <span class="hljs-typename">int64</span>
    FileName         <span class="hljs-typename">string</span>
    IndexFileName    <span class="hljs-typename">string</span>
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-config-"><strong>Config</strong></h2>
<p>Config stores several log settings. This is used to describe how the log
should be opened.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {
    FileMode      os.FileMode
    MaxRecordSize <span class="hljs-typename">int</span>
    Flags         <span class="hljs-typename">uint32</span>
    Version       <span class="hljs-typename">uint8</span>
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><blockquote>
<p><code>DefaultConfig</code> can be used for sensible default log configuration.</p>
</blockquote></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> DefaultConfig Config = Config{
    FileMode:      <span class="hljs-number">0600</span>,
    MaxRecordSize: DefaultMaxRecordSize,
    Flags:         DefaultRecordFlags,
    Version:       VersionOne,
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-open-a-log-file-"><strong>Open a log file</strong></h2>
<p>Open returns a <code>WriteAheadLog</code> implementation if no errors occur. If the
given filename already exists, the log file will try to be opened. If the
file format can be verified, the existing log will be returned. If the
file does not exist, a new log will be created with the given config.</p>
<p>If the file already exists and the file version is different than the given
<code>config.Version</code>, the file will remain the version in which is was created.
In other words the file will not be updated to the newer version.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="implementation">Implementation</h6></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">func</span> Open(filename <span class="hljs-typename">string</span>, config Config) (WriteAheadLog, error) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine if the given config is valid. If the given config is <code>nil</code>,
a <code>ErrConfigRequired</code> error will be returned.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> &amp;config == <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, ErrConfigRequired
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Open the file name, creating the file if it does not already exist. The
file is opened with the <code>APPEND</code> flag, which means all writes are
appended to the file. Additional file modes can be given with the config.</p></div></div><div class="code"><div class="wrapper">    file, err := os.OpenFile(filename, os.O_CREATE|os.O_APPEND|os.O_RDWR, config.FileMode)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there was an error opening the file, the open error is returned.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the file stat. The file size is gotten from this call. This helps
to determine if the file already has a header or not.</p></div></div><div class="code"><div class="wrapper">    stat, err := file.Stat()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Return an error if the <code>os.FileStat</code> could not be retrieved. The file
is closed before returning.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        file.Close()
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the file size suggests the header exists, open an existing file.
Otherwise create a new file based on the given config.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> stat.Size() &gt;= LogHeaderSize {
        <span class="hljs-keyword">return</span> openExisting(file, filename, config)
    }
    <span class="hljs-keyword">return</span> createNew(file, filename, config)
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="-utility-functions-"><strong>Utility functions</strong></h2>
<p>These functions assist in opening both new and existing log files.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-creates-a-v1-log-file-"><strong>Creates a v1 log file</strong></h3>
<p>This function is used when creating a v1 log file.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="-implementation-"><em>Implementation</em></h6></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">func</span> createVersionOne(file *os.File, filename <span class="hljs-typename">string</span>, config Config) (WriteAheadLog, error) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create the file header structure from the log flags and version.</p></div></div><div class="code"><div class="wrapper">    header := BasicFileHeader{flags: config.Flags, version: config.Version}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create the index file. If the file cannot be created, close the file
and return the error.</p></div></div><div class="code"><div class="wrapper">    index, err := VersionOneIndexFactory(filename+<span class="hljs-string">".idx"</span>, config.Version, config.Flags)
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        file.Close()
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create the record factory. All records will be created using this
factory.</p></div></div><div class="code"><div class="wrapper">    recordFactory := BasicLogRecordFactory(config.MaxRecordSize)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Stat the file to get the size. If unsuccessful, close the file and return
the error.</p></div></div><div class="code"><div class="wrapper">    stat, err := file.Stat()
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        file.Close()
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a lock for the log and wrap the file in an atomic writer. The
atomic writer syncs to disk after each write.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> lock sync.Mutex
    atomicWriter := NewAtomicWriter(file)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally, create the log file and return.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> &amp;versionOneLogFile{lock, file, atomicWriter, &amp;header, index,
        recordFactory, config.Flags, stat.Size(), CLOSED}, <span class="hljs-constant">nil</span>
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-creates-a-new-log-file-"><strong>Creates a new log file</strong></h3>
<p>A new log file is created with a file header consisting of a <code>LOG</code> signature
followed by an 8-bit version. The file header is then synced to disk and
a new log is created.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="implentation">Implentation</h6></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">func</span> createNew(file *os.File, filename <span class="hljs-typename">string</span>, config Config) (WriteAheadLog, error) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a buffer for the 4-byte file header.
The first 3 bytes contain the signature, <code>LOG</code>, followed by an 8-bit
version.</p></div></div><div class="code"><div class="wrapper">    buf := <span class="hljs-built_in">make</span>([]<span class="hljs-typename">byte</span>, <span class="hljs-number">8</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the <code>LOG</code> file signature to the first 3 bytes of the file.</p></div></div><div class="code"><div class="wrapper">    xbinary.LittleEndian.PutString(buf, <span class="hljs-number">0</span>, <span class="hljs-typename">string</span>(LogFileSignature))</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set file version to the given <code>config.Version</code>.</p></div></div><div class="code"><div class="wrapper">    buf[<span class="hljs-number">3</span>] = <span class="hljs-typename">byte</span>(config.Version)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the config flags into the buffer</p></div></div><div class="code"><div class="wrapper">    xbinary.LittleEndian.PutUint32(buf, <span class="hljs-number">4</span>, config.Flags)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Write the file header buffer to the file.</p></div></div><div class="code"><div class="wrapper">    _, err := file.Write(buf)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the header could not be written, close the file and return a
<code>ErrWriteLogHeader</code> error along with a <code>nil</code> log.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        file.Close()
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, ErrWriteLogHeader
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If writing the file header succeeded, sync the file header to disk.</p></div></div><div class="code"><div class="wrapper">    err = file.Sync()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the sync command failed, return a <code>ErrWriteLogHeader</code> error and a
<code>nil</code> log.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, ErrWriteLogHeader
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Returns the proper log parser based on the given <code>config.Version</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> selectVersion(file, filename, config)
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-opens-an-existing-log-file-"><strong>Opens an existing log file</strong></h3>
<p>Opens an existing file and returns a log based on the file header. If the
file contains a version which is not understood, the error
<code>ErrInvalidFileVersion</code> is returned along with a <code>nil</code> log.</p>
<p>If the file header cannot be read, an error is also returned.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="implementation">Implementation</h6></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">func</span> openExisting(file *os.File, filename <span class="hljs-typename">string</span>, config Config) (WriteAheadLog, error) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a buffer for the 8-byte file header.
The first 3 bytes are the signature <code>LOG</code> followed by an 8-bit version
and the boolean flags. Then read the file header into the buffer.</p></div></div><div class="code"><div class="wrapper">    buf := <span class="hljs-built_in">make</span>([]<span class="hljs-typename">byte</span>, <span class="hljs-number">8</span>)
    _, err := file.ReadAt(buf, <span class="hljs-number">0</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there was an error reading the file header, close the file and return
a nil log and the read error.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        file.Close()
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the header was read sucessfully, verify the file signature matches
the expected &quot;LOG&quot; signature. If the first 3 bytes do not match <code>LOG</code>,
return a <code>nil</code> log and a <code>ErrInvalidFileSignature</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> !bytes.Equal(buf[<span class="hljs-number">0</span>:<span class="hljs-number">3</span>], LogFileSignature) {
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, ErrInvalidFileSignature
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Read the boolean flags from the file header and overwrite the config
flags with the ones from the file.</p></div></div><div class="code"><div class="wrapper">    flags, err := xbinary.LittleEndian.Uint32(buf, <span class="hljs-number">4</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, err
    }
    config.Flags = flags</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The config version is updated to reflect the actual version of the file.
Then return the proper log parser based on the file version.</p></div></div><div class="code"><div class="wrapper">    config.Version = <span class="hljs-typename">uint8</span>(buf[<span class="hljs-number">3</span>])
    <span class="hljs-keyword">return</span> selectVersion(file, filename, config)
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="-select-log-version-"><strong>Select log version</strong></h3>
<p><code>selectVersion</code> is only here to make the code a bit <code>DRY</code>er. It simple
returns the proper log file based on the given version.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="implementation">Implementation</h6>
<p>Open the log file based on the current version of the file.
If the version is unrecognized, a <code>nil</code> log is returned as well as an
<code>ErrInvalidFileVersion</code> error.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">func</span> selectVersion(file *os.File, filename <span class="hljs-typename">string</span>, config Config) (WriteAheadLog, error) {
    <span class="hljs-keyword">switch</span> config.Version {
    <span class="hljs-keyword">case</span> VersionOne:
        <span class="hljs-keyword">return</span> createVersionOne(file, filename, config)
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-constant">nil</span>, ErrInvalidFileVersion
    }
}</div></div></div></div></body></html>